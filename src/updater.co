last_update = new Date

unread = 0

# icons need to be here in b64 because they are served from static.4chan.org
# without CORS headers, so drawing those to the canvas would taint it and
# prevent reexporting to the favicon
favicons =
  sfw: kup \img src: 'data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/8OXLv8AAAD/w5cu/wAAAP8AAAAAAAAAAAAAAP/Dly7/AAAA/8OXLv8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP/Dly7/w5cu/8OXLv8AAAD/AAAAAAAAAAAAAAD/w5cu/8OXLv/Dly7/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/w5cu/8OXLv/Dly7/AAAA/wAAAAAAAAAAAAAA/8OXLv/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAP/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAP/Dly7/w5cu/8OXLv/Dly7/AAAA/wAAAAAAAAAAAAAA/8OXLv/Dly7/w5cu/8OXLv8AAAD/AAAAAAAAAAAAAAAAAAAA/8OXLv/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAP/Dly7/w5cu/8OXLv8AAAD/AAAAAAAAAAAAAAAAAAAA/8OXLv/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/8OXLv/Dly7/w5cu/wAAAP8AAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAOvXAADBgwAAwYMAAMGDAADhhwAA888AAP//AAD//wAAw8MAAIGBAADBgwAAg8EAAMfj/////////////w=='
  nsfw: kup \img src: 'data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAABILAAASCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/zPMZv8AAAD/M8xm/wAAAP8AAAAAAAAAAAAAAP8zzGb/AAAA/zPMZv8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8zzGb/M8xm/zPMZv8AAAD/AAAAAAAAAAAAAAD/M8xm/zPMZv8zzGb/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/M8xm/zPMZv8zzGb/AAAA/wAAAAAAAAAAAAAA/zPMZv8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAP8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAP8zzGb/M8xm/zPMZv8zzGb/AAAA/wAAAAAAAAAAAAAA/zPMZv8zzGb/M8xm/zPMZv8AAAD/AAAAAAAAAAAAAAAAAAAA/zPMZv8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAP8zzGb/M8xm/zPMZv8AAAD/AAAAAAAAAAAAAAAAAAAA/zPMZv8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/zPMZv8zzGb/M8xm/wAAAP8AAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAOvXAADBgwAAwYMAAMGDAADhhwAA888AAP//AAD//wAAw8MAAIGBAADBgwAAg8EAAMfjAAD//////////w=='

# draw unread count on favicon
# adapted from https://github.com/tommoor/tinycon
# debounce slightly to prevent stuttering while scrolling
draw-favicon = debounce 200ms !->
  # the entire link needs to be replaced lest the icon won't update
  $ \favicon ?.remove!
  link = document.createElement \link
    &id   = \favicon
    &rel  = \icon
    &type = \image/x-icon # required for chrome, I guess

  document.createElement \canvas
    &width = 16
    &height = 16

    &getContext \2d
      &drawImage favicons[board.type], 0 0
      if unread > 0
        &font         = '8px monospace'
        &fillStyle    = \#000
        &strokeStyle  = \#fff
        &lineWidth    = 4
        &textBaseline = \bottom
        &textAlign    = \right

        &strokeText unread, 16 16
        &fillText   unread, 16 16
    link.href = &toDataURL \image/png
  document.head.appendChild link

export updater =
  update:  !->
    updater.status.textContent = "Updating thread..."
    updater.button.disabled = true

    new XMLHttpRequest
      &open \GET document.URL
      &responseType = \document

      &setRequestHeader \If-Modified-Since last_update.toUTCString!

      listen(&)
        .on \load !->
          if @status is 404
            document.title += '(dead)'
            updater.status.textContent = "thread 404'd"
            return
          if @status is 304
            updater.countdown.restart!
            return

          last_modified = new Date @getResponseHeader \Last-Modified

          unless last_modified > last_update
            updater.countdown.restart!
            return

          updater.status.textContent = "update detected, parsing"
          last_update := last_modified

          thread = parser.thread @response
          if thread.new.length > 0
            $ "t#{thread.id}" .lastElementChild # .replies
              .insertAdjacentHTML do
                \beforeend
                render_all thread.new, \article, 'new reply'

            for post of thread.new
              document.dispatchEvent new CustomEvent do
                \html5chan-postinserted
                detail: {post}

            # refresh backlinks
            # TODO refactor out all the various places backlinks are made
            # into something less coupled
            for backlinks of $$ '.thread .backlinks'
              backlinks.insertAdjacentHTML do
                \beforeend
                Post[backlinks.parentNode.dataset.id]backlinks true

            document.dispatchEvent new CustomEvent do
              \html5chan-update
              detail: {thread}

            unread += thread.new.length
            draw-favicon!

            fade-when-visible post for post of thread.new

            # if on the bottom of the page, smooth scroll to new posts
            if (window.scrollMaxY - window.scrollY) < 50 and not document.hidden
              last = window.scrollY
              repeat 50ms !->
                #if user scrolls upwards manually, abort.
                if last > window.scrollY
                  @stop!
                else if (remaining = window.scrollMaxY - window.scrollY) > 1
                  window.scrollBy 0, remaining / 4
                  last := window.scrollY

            # update post count
            $ "t#{thread.id}" .querySelector ".thread-info" .textContent =
              "#{thread.replies.length} replies \
               and #{thread.imageReplies.length} image replies."

          updater.countdown.restart!

        .on \timeout !->
          updater.status.textContent = "request timed out..."
          updater.countdown!

        .on \error !->
          updater.status.textContent = "Couldn't fetch thread page!"

        .on \loadend !-> updater.button.disabled = false

      &send!

  countdown: repeat 1000ms {-start} !(t) ->
    @t = t or @t or 30sec

    updater.status.textContent = "Updating in #{@t} seconds..."

    if --@t is 0
      @stop!
      updater.update!

fade = !(post) ->
  # running immediately seems to break CSS yellow fade.
   defer 100ms !->
    post.classList.remove \new
    --unread
    draw-favicon!

fade-when-visible = !->
  post = $ "p#{it.id}"

  y = post.offsetTop

  if (window.innerHeight + window.scrollY) > y
    if document.hidden
      # fade them once the window/tab is visible again
      listen window .once \focus !-> fade post
    else
      # now
      fade post
  else
    # wait until scrolled to
    listen window .scroll function reset
      if ( window.innerHeight + window.scrollY ) > post.offsetTop
        fade post
        listen window .off \scroll reset

onready !->
  updater.status = $ \update-status
  updater.button = $ \update-now

  # autoupdate threads
  if board.isThread
    updater.countdown.start!
    listen $ \update-now .click !->
      updater.countdown
        &stop!
        &t = 30ms
      updater.update!
  else
    $ \updater .hidden = true

